<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>File Editor - {{ filename }}</title>
    <!-- CodeMirror 5 (stable CDN) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/comment/comment.min.js"></script>

    <style>
      :root { --bg: #0f1720; --card: #0b1220; --accent: #6ee7b7; --muted: #9aa4b2; }
      body { margin: 0; height: 100vh; font-family: Inter, Arial, sans-serif; background: linear-gradient(180deg,#071021 0%, #0b1220 100%); color: #e6eef6; }
      .container { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; padding: 18px; height: 100vh; box-sizing: border-box; }
      .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: 12px; padding: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.6); overflow: hidden; }
      .editor-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
      .title { font-weight:600; font-size:16px; color:var(--accent); }
      .toolbar { display:flex; gap:8px; }
      .btn { background:#07202a; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
      .btn.primary { background: linear-gradient(90deg,#0ea5a6,#6ee7b7); color:#042024; }
      .status { font-size:13px; color:var(--muted); }

      .editor-wrap { height: calc(100vh - 110px); border-radius: 8px; overflow: hidden; }
      .CodeMirror { height: 100% !important; font-size: 14px; }

      /* right column placeholder - user will populate later */
      .right { display:flex; flex-direction:column; gap:10px; }
      .placeholder { flex:1; border-radius:8px; padding:12px; background:rgba(255,255,255,0.02); color:var(--muted); }

      /* Flash messages */
      .flash { padding: 8px; margin-bottom: 10px; border-radius: 6px; }
      .success { background: #062b19; border: 1px solid #0f8b4f; color: #8cf0b6; }
      .error { background: #2a0b0b; border: 1px solid #8b2f2f; color: #ffb3b3; }

      @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .right { display:none; } }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <div class="editor-header">
          <div>
            <div class="title">Editing: {{ filename }}</div>
            <div class="status">Python file editor â€” left side UI. Right side reserved.</div>
          </div>
          <div class="toolbar">
            <form id="saveForm" action="{{ url_for('save') }}" method="post" style="display:inline;">
              <input type="hidden" name="filename" value="{{ filename }}">
              <input type="hidden" name="content" id="contentInput">
              <button type="submit" class="btn primary" id="saveBtn">Save</button>
            </form>
            <a class="btn" href="{{ url_for('download') }}?filename={{ filename }}">Download</a>
          </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="flash {{ category }}">{{ msg }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="editor-wrap">
          <textarea id="editorTextarea" name="editor">{{ content|e }}</textarea>
        </div>
      </div>

      <div class="panel right">
        <div class="placeholder" style="display:flex;flex-direction:column;gap:8px;">
          <div style="font-weight:700;margin-bottom:6px;color:var(--accent);">Chat Interface</div>
          <div id="chatMessages" style="flex:1; display:flex; flex-direction:column; gap:8px; overflow:auto; padding:8px; background:rgba(255,255,255,0.01); border-radius:6px;"></div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            <input id="chatInput" placeholder="Ask a question or say hi" style="flex:1; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;" />
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize CodeMirror on the textarea
      const textarea = document.getElementById('editorTextarea');
      const editor = CodeMirror.fromTextArea(textarea, {
        mode: 'python',
        theme: 'dracula',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        autoCloseBrackets: true,
        matchBrackets: true,
        extraKeys: { 'Ctrl-/': 'toggleComment' }
      });

      // Before the save form submits, copy editor content to hidden input so server receives it
      const saveForm = document.getElementById('saveForm');
      const contentInput = document.getElementById('contentInput');
      saveForm.addEventListener('submit', function(e){
        contentInput.value = editor.getValue();
      });

      // Improve editor focus and keyboard handling
      editor.on('keydown', function(cm, event) {
        if (event.key === 'Tab') {
          if (cm.somethingSelected()) cm.indentSelection('add');
          else cm.replaceSelection(' '.repeat(cm.getOption('indentUnit')));
          event.preventDefault();
        }
      });
    </script>
    <script>
      // Chat UI logic for the right panel
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');

      function appendMessage(text, who='bot'){
        const el = document.createElement('div');
        el.style.padding = '10px 12px';
        el.style.borderRadius = '12px';
        el.style.maxWidth = '80%';
        el.style.wordBreak = 'break-word';
        el.style.boxSizing = 'border-box';
        if(who === 'me'){
          el.style.background = 'linear-gradient(90deg,#6ee7b7,#0ea5a6)';
          el.style.color = '#042024';
          el.style.alignSelf = 'flex-end';
          el.style.border = '1px solid rgba(0,0,0,0.1)';
          el.textContent = text;
        } else {
          el.style.background = 'rgba(255,255,255,0.02)';
          el.style.color = 'var(--muted)';
          el.style.alignSelf = 'flex-start';
          el.style.border = '1px solid rgba(255,255,255,0.03)';
          el.textContent = text;
        }
        chatMessages.appendChild(el);
        // keep scroll at bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage(){
        const text = chatInput.value.trim();
        if(!text) return;
        appendMessage(text, 'me');
        chatInput.value = '';
        try{
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });
          const j = await res.json();
          appendMessage(j.reply || 'No reply');
        }catch(e){
          appendMessage('Error communicating with server', 'bot');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      chatInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendMessage(); });

      // Add a greeting message on load
      appendMessage('Hello! This chat answers with a friendly greeting. Try saying "hi" or ask a question.');
    </script>
  </body>
</html>
